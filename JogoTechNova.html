<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TechNova — Labirinto de Segurança (Loja + Pause entre fases)</title>
  <style>
    :root{
      --bg:#0f1221; --panel:#171a2e; --panel-2:#0b0d1a; --text:#e8ecff; --muted:#b7c0ff;
      --accent:#7ae0ff; --ok:#57f287; --bad:#ff6b6b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% -200px,#1b2146 0%,#0f1221 45%,#090b14 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .layout{display:grid;grid-template-rows:auto 1fr auto;min-height:100%}
    header{display:flex;gap:.75rem;align-items:center;padding:16px 20px;background:linear-gradient(180deg,#12162c,#0b0d1a);border-bottom:1px solid #1f2446}
    header h1{font-size:18px;margin:0;letter-spacing:.3px}
    header .badge{padding:4px 10px;border-radius:999px;background:rgba(122,224,255,.12);color:var(--accent);font-weight:600;font-size:12px;border:1px solid rgba(122,224,255,.35)}
    .hud{display:flex;gap:14px;align-items:center;margin-left:auto}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid #2a2f58;background:#121733;border-radius:10px;min-height:30px}
    .chip b{font-size:14px}
    #gameWrap{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px;max-width:1200px;margin:0 auto;width:100%}
    #viewport{position:relative;height:380px;border:1px solid #242a54;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#0e1331 0%,#0a0e24 60%,#060814 100%)}
    .ground{position:absolute;left:0;right:0;bottom:0;height:64px;background:linear-gradient(0deg,#0c1129,#0e1440);border-top:1px solid #25306e}
    .platform{position:absolute;bottom:64px;height:10px;background:linear-gradient(180deg,#2b3473,#1a2152);border:1px solid #3340a0;border-radius:6px}
    .platform::after{content:"";position:absolute;inset:-1px;border-radius:6px;box-shadow:0 6px 16px rgba(36,52,160,.35)}
    .entity{position:absolute;width:30px;height:30px;border-radius:6px}
    #player{background:linear-gradient(180deg,#66d1ff,#1e88ff);box-shadow:0 8px 18px rgba(30,136,255,.35)}
    .enemy{background:linear-gradient(180deg,#ff6b6b,#b32a2a);box-shadow:0 8px 18px rgba(255,107,107,.35);border:1px solid rgba(0,0,0,.2)}
    .enemy.fast{filter:brightness(1.1)}
    .enemy.tank{outline:2px solid #ffd166}
    .enemy.fly{outline:2px solid #7ae0ff}
    .hpbar{position:absolute;bottom:32px;left:0;right:0;height:4px;background:#1a1f44;border:1px solid #2a2f58;border-radius:4px;overflow:hidden}
    .hpbar>span{display:block;height:100%;background:linear-gradient(90deg,#57f287,#3a8bff);width:100%}
    .pickup{position:absolute;width:20px;height:20px;border-radius:50%;background:linear-gradient(180deg,#57f287,#1f8a4c);border:1px solid rgba(0,0,0,.2);box-shadow:0 6px 12px rgba(87,242,135,.35)}
    .turret{position:absolute;width:18px;height:26px;background:linear-gradient(180deg,#7ae0ff,#2d6cf0);border:1px solid #2445a0;border-radius:4px 4px 2px 2px;bottom:64px}
    .bullet{position:absolute;width:8px;height:4px;border-radius:2px;background:#e8ecff;box-shadow:0 0 10px rgba(232,236,255,.6)}
    .base{position:absolute;left:0;bottom:64px;width:22px;height:140px;background:linear-gradient(180deg,#223065,#121842);border-right:2px solid #3a4da0;border-top:1px solid #2a3a84;border-bottom:1px solid #2a3a84}
    .msg{position:absolute;top:10px;left:10px;padding:6px 10px;background:rgba(0,0,0,.25);border:1px solid #2a325e;border-radius:8px;font-size:12px;color:#b7c0ff}
    aside{border:1px solid #242a54;border-radius:14px;background:linear-gradient(180deg,#0f1436,#0c1030);padding:14px}
    .card{border:1px solid #2a2f58;border-radius:12px;background:#0d1232;padding:14px;margin-bottom:12px}
    .card h3{margin:0 0 6px;font-size:14px;color:#b7c0ff}
    .progress{height:8px;background:#141939;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,#3a8bff,#57f287);width:0%}
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(5,7,16,.85),rgba(6,8,20,.78));display:flex;align-items:center;justify-content:center;padding:20px 14px}
    .overlay.hidden{display:none}
    .modal{max-width:860px;width:100%;background:linear-gradient(180deg,#111736,#0b0f26);border:1px solid #2a2f58;border-radius:16px;box-shadow:0 30px 80px rgba(0,0,0,.45)}
    .modal header{border-bottom:1px solid #25306e;padding:14px 16px;background:linear-gradient(180deg,#121733,#0e132e)}
    .modal h2{margin:0;font-size:18px}
    .modal .content{padding:16px}
    .modal p{margin:0 0 10px;line-height:1.5;color:#dbe2ff}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    button{cursor:pointer;border:1px solid #2a2f58;background:#121733;color:#e8ecff;padding:10px;border-radius:10px;font-weight:600}
    button:hover{background:#161d46}
    .toast{position:fixed;right:16px;bottom:16px;background:#121733;border:1px solid #2a2f58;border-radius:12px;padding:10px 12px;font-size:13px;color:#dbe2ff;box-shadow:0 10px 26px rgba(0,0,0,.35);opacity:0;transform:translateY(10px);transition:all .25s}
    .toast.show{opacity:1;transform:translateY(0)}
    footer{padding:10px 16px;color:#8e9afc;font-size:12px;border-top:1px solid #1f2446}
    .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .shop-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  </style>
</head>
<body>
<div class="layout">
  <header>
    <span class="badge">TechNova • Labirinto de Segurança</span>
    <h1>Loja + Inventário + Pausa entre fases</h1>
    <div class="hud">
      <div class="chip">Pontuação: <b id="score">0</b></div>
      <div class="chip">Fase: <b id="stage">1/10</b></div>
      <div class="chip">Escudos: <b id="shields">0</b></div>
      <div class="chip">Dinheiro: <b id="money">$0</b></div>
      <div class="chip">Base: <b id="basehp">10</b></div>
      <div class="chip">Torres: <b id="invCount">0</b></div>
      <button id="openShop" style="margin-left:10px">Abrir Loja (P)</button>
    </div>
  </header>

  <main id="gameWrap">
    <section id="viewport" title="Clique para posicionar torres quando tiver no inventário">
      <div id="base" class="base"></div>
      <div class="ground"></div>

      <div class="platform" style="left:40px;width:140px;bottom:110px"></div>
      <div class="platform" style="left:260px;width:180px;bottom:160px"></div>
      <div class="platform" style="left:520px;width:120px;bottom:120px"></div>

      <div id="player" class="entity" style="left:40px;top:230px"></div>
      <div class="msg">Setas/WASD para mover • Espaço para pular • Clique no campo para colocar torres</div>
    </section>

    <aside>
      <div class="card">
        <h3>Progresso</h3>
        <div class="progress"><span id="bar" style="width:0%"></span></div>
        <p style="color:#b7c0ff;font-size:12px">Após cada etapa/wave, o jogo entra em <b>Pausa</b> para compras e posicionamento.</p>
      </div>
      <div class="card">
        <h3>Resultados</h3>
        <p>12–16: <b>Empresa protegida</b><br>8–11: <b>Analista em formação</b><br>&lt;8: <b>Empresa comprometida</b></p>
      </div>
    </aside>
  </main>

  <footer>
    © 2025 TechNova. Controles: ← → / A D para mover, ↑ / W / Espaço para pular. Clique no campo para posicionar torres (se tiver no inventário). Tecla P abre a loja.
  </footer>
</div>

<!-- Overlay de PERGUNTAS -->
<div class="overlay" id="overlay" aria-modal="true" role="dialog">
  <div class="modal" role="document">
    <header><h2 id="ov-title">Início – O Desafio</h2></header>
    <div class="content">
      <p id="ov-text">A empresa TechNova sofreu tentativas de invasão. Você deve manter os serviços online e proteger os dados.</p>
      <div class="options">
        <button id="optA">Opção A</button>
        <button id="optB">Opção B</button>
      </div>
      <p class="tip" id="ov-concept"></p>
    </div>
  </div>
</div>

<!-- Overlay de LOJA/INVENTÁRIO -->
<div class="overlay hidden" id="shop" aria-modal="true" role="dialog">
  <div class="modal" role="document">
    <header><h2>Loja & Inventário</h2></header>
    <div class="content">
      <p>Dinheiro: <b id="moneyShop">$0</b> • Escudos: <b id="shieldsShop">0</b> • Torres no inventário: <b id="invShop">0</b></p>
      <div class="shop-grid">
        <button id="buySpeed">Velocidade (+0.8) – $60</button>
        <button id="buyJump">Pulo (+2) – $60</button>
        <button id="buyShield">Escudo (+1) – $40</button>
        <button id="buyTurret">Comprar Torre (inventário +1) – $120</button>
        <button id="equipTurret">Colocar Torre agora</button>
        <button id="closeShop">Continuar Jogando</button>
      </div>
      <div class="shop-footer">
        <button id="nextStageBtn" class="primary" style="display:none">Avançar para a próxima etapa</button>
      </div>
      <p class="tip" style="margin-top:10px">Dica: após clicar em <b>Colocar Torre</b>, clique no campo de jogo para posicionar (não muito perto da EMPRESA).</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ----------------------- CONSTANTES -----------------------
const BASE_SPEED = 3.2;
const BASE_JUMP  = -12;
const G = 0.8;

// ----------------------- FASES -----------------------
const STAGES = [
  { title: "1. Início – O Desafio",
    text: "A empresa TechNova sofreu tentativas de invasão. Objetivo: terminar a missão com zero incidentes graves e dados protegidos.",
    concept: "",
    A: { label: "Ir sem plano (apertar o passo)", effect: { delta:-1, enemies:2, note:"Decisão apressada: você começa vulnerável." } },
    B: { label: "Assumir o controle da segurança", effect: { delta:+2, money:50, bonus:"Confiança da diretoria" } }
  },
  { title: "2. Fundamentos e Análise de Riscos",
    text: "Servidor está exposto à internet.",
    concept: "Gestão de riscos e planejamento preventivo.",
    A: { label: "Publicar direto na nuvem, sem restrições", effect: { delta:-3, enemies:3, note:"Vazamento de dados! Você ignorou riscos." } },
    B: { label: "Fazer análise de riscos antes da publicação", effect: { delta:+2, money:50, bonus:"Escudo de prevenção" } }
  },
  { title: "3. Políticas e Planos de Segurança",
    text: "Equipe solicita acesso total aos servidores.",
    concept: "Menor privilégio, políticas e conformidade.",
    A: { label: "Acesso irrestrito (mais rápido)", effect: { delta:-1, enemies:3, note:"Credenciais expostas." } },
    B: { label: "Política de senhas, perfis e controle de acesso", effect: { delta:+2, money:50 } }
  },
  { title: "4. Auditoria e Normas",
    text: "Cliente exige conformidade.",
    concept: "Auditoria, ISO 27001, NIST, LGPD.",
    A: { label: "Ignorar normas (tem antivírus)", effect: { delta:-3, enemies:4, note:"Penalidade por não conformidade." } },
    B: { label: "Implementar controles ISO 27001 e LGPD", effect: { delta:+2, money:50, bonus:"Selo de conformidade" } }
  },
  { title: "5. Firewalls, IDS/IPS e Monitoramento",
    text: "Tráfego suspeito vindo do exterior.",
    concept: "Camadas de defesa e resposta.",
    A: { label: "Abrir todas as portas", effect: { delta:-3, enemies:5, note:"Invasão total — porta 22." } },
    B: { label: "Configurar firewall e IDS/IPS", effect: { delta:+2, money:50 } }
  },
  { title: "6. Softwares Maliciosos",
    text: "E-mail de 'fatura urgente' chega ao financeiro.",
    concept: "Engenharia social e conscientização.",
    A: { label: "Abrir o anexo", effect: { delta:-3, enemies:5, note:"Ransomware criptografou o servidor." } },
    B: { label: "Treinar a equipe sobre phishing", effect: { delta:+2, money:50 } }
  },
  { title: "7. Proteção de Aplicações Web",
    text: "Formulários sem validação.",
    concept: "WAF e validações.",
    A: { label: "Ignorar, ninguém vai invadir", effect: { delta:-3, enemies:6, note:"SQL Injection roubou o banco." } },
    B: { label: "Implementar filtros, WAF e IP", effect: { delta:+2, money:50 } }
  },
  { title: "8. Criptografia e Proteção de Dados",
    text: "Dados de clientes sem criptografia.",
    concept: "Confidencialidade e integridade.",
    A: { label: "Armazenar em texto simples", effect: { delta:-3, enemies:7, note:"Dados vazaram, multa LGPD." } },
    B: { label: "Criptografar e usar chaves seguras", effect: { delta:+2, money:50 } }
  },
  { title: "9. Detecção e Resposta a Incidentes",
    text: "IDS detecta anomalias.",
    concept: "Detecção → contenção → erradicação → recuperação.",
    A: { label: "Ignorar o alerta", effect: { delta:-3, enemies:8, note:"Ataque escalou e paralisou serviços." } },
    B: { label: "Acionar o plano de resposta a incidentes", effect: { delta:+2, money:50 } }
  },
  { title: "10. Encerramento – Resultado",
    text: "Some a pontuação final.",
    concept: "",
    A: { label: "Reiniciar missão", effect: { delta:0 } },
    B: { label: "Ver resultado", effect: { delta:0 } }
  }
];

// ----------------------- ESTADO -----------------------
const viewport = document.getElementById('viewport');
const player   = document.getElementById('player');
const scoreEl  = document.getElementById('score');
const stageEl  = document.getElementById('stage');
const shieldsEl= document.getElementById('shields');
const moneyEl  = document.getElementById('money');
const basehpEl = document.getElementById('basehp');
const invEl    = document.getElementById('invCount');
const barEl    = document.getElementById('bar');
const overlay  = document.getElementById('overlay');
const ovTitle  = document.getElementById('ov-title');
const ovText   = document.getElementById('ov-text');
const ovConcept= document.getElementById('ov-concept');
const optA     = document.getElementById('optA');
const optB     = document.getElementById('optB');
const shop     = document.getElementById('shop');
const moneyShop= document.getElementById('moneyShop');
const shieldsShop= document.getElementById('shieldsShop');
const invShop  = document.getElementById('invShop');
const nextStageBtn = document.getElementById('nextStageBtn');
const openShopBtn  = document.getElementById('openShop');
const toast    = document.getElementById('toast');

let score=0, stage=0, shields=0, money=0, baseHP=10;
let keys = { left:false, right:false, up:false };
let px=40, py=230, vx=0, vy=0;
let SPEED = BASE_SPEED;
let JUMP  = BASE_JUMP;
let enemies=[], enemyWaveRemaining=0, gameActive=true;
let turrets=[], bullets=[];
let turretInventory=0;
let loopRunning=false, rafId=null;
let paused=false;
let pendingNextStage=false;
let placingTurretMode=false;

// Tipos de inimigos
const ENEMY_TYPES = {
  fast:  { hp:1,  vx:-2.6, y:210, reward:5, class:'fast' },
  tank:  { hp:3,  vx:-1.2, y:210, reward:8, class:'tank' },
  fly:   { hp:2,  vx:-1.8, y:140, reward:6, class:'fly' }
};

function showToast(text){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1600); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function resetPlayer(){ px=40; py=230; vx=0; vy=0; }
function updateHUD(){
  scoreEl.textContent=score;
  stageEl.textContent=`${Math.min(stage+1,10)}/10`;
  shieldsEl.textContent=shields;
  moneyEl.textContent=`$${money}`;
  basehpEl.textContent=baseHP;
  invEl.textContent=turretInventory;
  barEl.style.width=`${(stage)/(STAGES.length-1)*100}%`;
  moneyShop.textContent=`$${money}`;
  shieldsShop.textContent=shields;
  invShop.textContent=turretInventory;
}

// ----------------------- Waves -----------------------
function spawnEnemy(typeKey){
  const t = ENEMY_TYPES[typeKey] || ENEMY_TYPES.fast;
  const el = document.createElement('div');
  el.className = `entity enemy ${t.class||''}`.trim();
  el.style.left = (viewport.clientWidth-40)+'px';
  el.style.top  = t.y+'px';

  const hpbar = document.createElement('div');
  hpbar.className='hpbar';
  const fill = document.createElement('span');
  hpbar.appendChild(fill);
  el.appendChild(hpbar);

  viewport.appendChild(el);
  const obj = { el, x: viewport.clientWidth-40, y: t.y, vx: t.vx, hp: t.hp, maxhp: t.hp, type: typeKey };
  enemies.push(obj);
  return obj;
}

function startWave(baseCount){
  const tanks = Math.floor(baseCount * Math.min(0.4, stage/12));
  const flyers= Math.floor(baseCount * Math.min(0.5, stage/10));
  const fasts = Math.max(0, baseCount - tanks - flyers);

  const make = (n, type)=>{ for(let i=0;i<n;i++){ setTimeout(()=>spawnEnemy(type), 220*(i + Math.floor(Math.random()*2))); } };
  enemyWaveRemaining = baseCount;
  make(fasts,'fast'); make(tanks,'tank'); make(flyers,'fly');
}

function clearEnemies(){ enemies.forEach(o=>o.el.remove()); enemies=[]; enemyWaveRemaining=0; }

// ----------------------- Overlays / Etapas -----------------------
function presentStage(){
  const s = STAGES[stage];
  const order = Math.random()<0.5 ? ['A','B'] : ['B','A'];
  ovTitle.textContent = s.title;
  ovText.textContent  = s.text;
  ovConcept.textContent = s.concept||'';
  optA.textContent = s[order[0]].label;
  optB.textContent = s[order[1]].label;
  optA.onclick = ()=>handleChoice(order[0]);
  optB.onclick = ()=>handleChoice(order[1]);
  overlay.classList.remove('hidden');
  overlay.style.display='flex';
}

function applyEffect(effect){
  if(effect.delta) score+=effect.delta;
  if(effect.money){ money+=effect.money; showToast(`Recompensa: +$${effect.money}`); }
  if(effect.bonus){ shields+=1; pickupBonus(px+8, py-10); showToast("Bônus: "+effect.bonus); }
  if(effect.note) showToast(effect.note);
  if(effect.enemies){
    const baseCount = Math.max(2, effect.enemies + Math.floor(stage*0.7));
    startWave(baseCount);
  }
  updateHUD();
}

function nextStage(){
  stage = Math.min(stage+1, STAGES.length-1);
  updateHUD();
  presentStage();
}

// ----------------------- Input -----------------------
window.addEventListener('keydown', (e)=>{
  const k=e.key;
  if(k==='p' || k==='P'){ toggleShopPause(false); return; }
  const isMove=['ArrowLeft','ArrowRight','ArrowUp','a','A','d','D','w','W',' '].includes(k);
  if(isMove && overlay.classList.contains('hidden')) e.preventDefault();
  if(['ArrowLeft','a','A'].includes(k)) keys.left=true;
  if(['ArrowRight','d','D'].includes(k)) keys.right=true;
  if(['ArrowUp','w','W',' '].includes(k)) keys.up=true;
});
window.addEventListener('keyup', (e)=>{
  const k=e.key;
  if(['ArrowLeft','a','A'].includes(k)) keys.left=false;
  if(['ArrowRight','d','D'].includes(k)) keys.right=false;
  if(['ArrowUp','w','W',' '].includes(k)) keys.up=false;
});

// Posicionar torres com clique
viewport.addEventListener('click', (e)=>{
  if(!placingTurretMode) return;
  if(turretInventory<=0){ showToast('Sem torres no inventário'); placingTurretMode=false; return; }
  const vr = viewport.getBoundingClientRect();
  const x = e.clientX - vr.left;
  const y = viewport.clientHeight - 64 - 26;
  if(x < 40) { showToast('Muito perto da EMPRESA. Posicione mais à direita.'); return; }
  placeTurret(Math.min(Math.max(x-9, 40), viewport.clientWidth-30), y);
  turretInventory--; placingTurretMode=false; updateHUD();
});

// ----------------------- Torres / Tiros -----------------------
function placeTurret(x,y){
  const t=document.createElement('div'); t.className='turret'; t.style.left=x+'px'; t.style.top=y+'px';
  viewport.appendChild(t); turrets.push({el:t,x,y,cool:0});
}
function shootFrom(t){
  if(paused) return;
  const b=document.createElement('div'); b.className='bullet';
  const y=t.y+10, x=t.x+18;
  b.style.top=y+'px'; b.style.left=x+'px';
  viewport.appendChild(b);
  bullets.push({el:b,x:x,y:y,vx:4.2, dmg:1});
}
setInterval(()=>{ turrets.forEach(t=>shootFrom(t)); }, 850);

// ----------------------- Util -----------------------
function pickupBonus(x,y){ const p=document.createElement('div'); p.className='pickup'; p.style.left=x+'px'; p.style.top=y+'px'; viewport.appendChild(p); setTimeout(()=>p.remove(),1000); }

function clearTurrets(){ turrets.forEach(t=>t.el.remove()); turrets=[]; }
function resetGame(){
  if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
  loopRunning=false; paused=false; pendingNextStage=false; placingTurretMode=false;
  clearEnemies(); clearTurrets();
  bullets.forEach(b=>b.el.remove()); bullets=[];
  score=0; shields=0; money=0; baseHP=10; stage=0; enemyWaveRemaining=0; gameActive=true; turretInventory=0;
  SPEED = BASE_SPEED; JUMP = BASE_JUMP;
  resetPlayer(); updateHUD(); presentStage(); startLoop();
}
function loseByTurret(){ showToast('Sua torre foi destruída! Reiniciando...'); setTimeout(()=>resetGame(),700); }
function loseByBase(){ showToast('A EMPRESA foi atingida! Reiniciando...'); setTimeout(()=>resetGame(),700); }

// ----------------------- Pause/Shop -----------------------
function toggleShopPause(nextStageAfterClose){
  paused = !paused;
  pendingNextStage = !!nextStageAfterClose;
  if(paused){
    shop.classList.remove('hidden'); shop.style.display='flex';
    moneyShop.textContent=`$${money}`; shieldsShop.textContent=shields; invShop.textContent=turretInventory;
    nextStageBtn.style.display = pendingNextStage ? 'inline-flex' : 'none';
  }else{
    shop.style.display='none'; shop.classList.add('hidden');
    if(pendingNextStage){
      pendingNextStage=false;
      presentStage();
    }
  }
}
document.getElementById('closeShop').onclick = ()=> toggleShopPause(false);
document.getElementById('equipTurret').onclick = ()=>{ placingTurretMode=true; showToast('Clique no campo para posicionar a torre'); };
document.getElementById('nextStageBtn').onclick = ()=> toggleShopPause(true);
openShopBtn.onclick = ()=> toggleShopPause(false);

// ----------------------- Loop (guard + pause) -----------------------
function startLoop(){
  if(loopRunning) return;
  loopRunning=true;
  const step = ()=>{
    // pulo de lógica quando em pausa (mantém render loop)
    if(!paused){
      // movimento
      vx = (keys.left?-SPEED:0) + (keys.right?SPEED:0);
      px += vx; px = clamp(px, 4, viewport.clientWidth-34);

      // gravidade/plataformas
      const plats = Array.from(document.querySelectorAll('.platform'));
      let groundY = viewport.clientHeight-64-30;
      let supportY = groundY, onGround=false;
      for(const p of plats){
        const rect=p.getBoundingClientRect(), vr=viewport.getBoundingClientRect();
        const x=rect.left-vr.left, y=rect.top-vr.top, w=rect.width;
        if(px+30>x && px<x+w && py+30<=y && y-30<supportY) supportY=y-30;
      }
      if(py>=supportY){ onGround=true; py=supportY; vy=0; }
      if(keys.up && onGround){ vy=JUMP; onGround=false; }
      vy += G; py += vy; if(py>supportY){ py=supportY; vy=0; }

      // aplicar no DOM
      player.style.left=px+'px'; player.style.top=py+'px';

      // inimigos
      enemies.forEach((o,idx)=>{
        o.x += o.vx;
        o.el.style.left = o.x+'px';

        const fill = o.el.querySelector('.hpbar>span');
        if(fill){ fill.style.width = Math.max(0, (o.hp/o.maxhp*100))+'%'; }

        // base
        if(o.x <= 12){
          enemyWaveRemaining = Math.max(0, enemyWaveRemaining-1);
          o.el.remove(); enemies.splice(idx,1);
          loseByBase(); return;
        }

        // torre
        for(const t of turrets){
          const tx=t.x, ty=t.y, tw=18, th=26;
          const ex=o.x, ey=o.y;
          if(!(ex+30<tx || ex>tx+tw || ey+30<ty || ey>ty+th)){ loseByTurret(); return; }
        }

        // jogador
        const ex=o.x, ey=o.y;
        const hit = !(px+30<ex || px>ex+30 || py+30<ey || py>ey+30);
        const stomp = (vy>1 && py+30>=ey && py+20<=ey);
        if(hit){
          if(stomp){
            vy = JUMP*0.55;
            o.hp -= 2;
            if(o.hp<=0){
              o.el.remove(); enemies.splice(idx,1);
              enemyWaveRemaining=Math.max(0, enemyWaveRemaining-1);
              score+=1; money+=ENEMY_TYPES[o.type].reward; updateHUD(); pickupBonus(ex+8, ey-8);
              if(enemyWaveRemaining===0 && stage<STAGES.length-1){
                setTimeout(()=>{
                  showToast('Onda controlada. Pausa para compras.');
                  toggleShopPause(true); // pausa e habilita "Próxima etapa"
                }, 600);
              }
            }
          } else {
            if(shields>0){ shields -= 1; showToast('Escudo absorveu o dano.'); }
            else { score -= 1; showToast('Você sofreu dano (−1).'); }
            updateHUD(); resetPlayer();
          }
        }
      });

      // balas
      bullets.forEach((b,bi)=>{
        b.x += b.vx; b.el.style.left=b.x+'px';
        enemies.forEach((o,ei)=>{
          const ex=o.x, ey=o.y;
          if(!(b.x+8<ex || b.x>ex+30 || b.y+4<ey || b.y>ey+30)){
            o.hp -= b.dmg;
            b.el.remove(); bullets.splice(bi,1);
            if(o.hp<=0){
              o.el.remove(); enemies.splice(ei,1);
              enemyWaveRemaining=Math.max(0, enemyWaveRemaining-1);
              score += 1; money += ENEMY_TYPES[o.type].reward; updateHUD();
              if(enemyWaveRemaining===0 && stage<STAGES.length-1){
                setTimeout(()=>{
                  showToast('Onda controlada. Pausa para compras.');
                  toggleShopPause(true);
                }, 600);
              } else {
                const fill = o.el.querySelector('.hpbar>span');
                if(fill){ fill.style.width = Math.max(0, (o.hp/o.maxhp*100))+'%'; }
              }
            }
          }
        });
        if(b.x>viewport.clientWidth){ b.el.remove(); bullets.splice(bi,1); }
      });
    }

    rafId = requestAnimationFrame(step);
  };
  rafId = requestAnimationFrame(step);
}

// ----------------------- Decisões -----------------------
function handleChoice(which){
  const s=STAGES[stage]; const eff=s[which].effect||{}; overlay.style.display='none';
  applyEffect(eff);
  const risky=(which==='A');

  if(stage===STAGES.length-1){
    if(which==='A'){ resetGame(); return; }
    if(which==='B'){
      const total=score;
      const verdict = total>=12 ? 'Empresa protegida' : (total>=8 ? 'Analista em formação' : 'Empresa comprometida');
      setTimeout(()=>{
        overlay.style.display='flex';
        ovTitle.textContent='Fim da Missão';
        ovText.textContent=`Pontuação final: ${total}. Resultado: ${verdict}. Dinheiro: $${money}.`;
        ovConcept.textContent='Obrigado por jogar!';
        optA.textContent='Reiniciar'; optB.textContent='Fechar';
        optA.onclick=()=>resetGame(); optB.onclick=()=>{ overlay.style.display='none'; };
      },250);
      return;
    }
  }

  if(!risky){
    // antes de ir para a próxima etapa, pausa para compras
    setTimeout(()=>{
      showToast('Decisão segura. Pausa para compras.');
      toggleShopPause(true);
    }, 420);
  } else {
    // se a etapa arriscada não definiu wave explícita, crie uma leve
    if(!eff.enemies){
      startWave(Math.max(2, 2+Math.floor(stage*0.5)));
    }
  }
}

// ----------------------- Loja -----------------------
const buySpeed  = document.getElementById('buySpeed');
const buyJump   = document.getElementById('buyJump');
const buyTurret = document.getElementById('buyTurret');
const buyShield = document.getElementById('buyShield');
const equipTurret = document.getElementById('equipTurret');
function tryBuy(cost, fn){ if(money < cost){ showToast('Dinheiro insuficiente.'); return; } money -= cost; updateHUD(); fn(); }

buySpeed.onclick  = ()=> tryBuy(60, ()=>{ SPEED += 0.8; showToast('Velocidade +0.8'); });
buyJump.onclick   = ()=> tryBuy(60, ()=>{ JUMP -= 2; showToast('Pulo +2'); });
buyShield.onclick = ()=> tryBuy(40, ()=>{ shields += 1; updateHUD(); showToast('Escudo +1'); });
buyTurret.onclick = ()=> tryBuy(120,()=>{ turretInventory += 1; updateHUD(); showToast('Torre adicionada ao inventário.'); });
equipTurret.onclick = ()=>{ placingTurretMode = true; showToast('Clique no campo para posicionar a torre'); };

// ----------------------- Start -----------------------
updateHUD(); presentStage(); startLoop();
</script>
</body>
</html>
